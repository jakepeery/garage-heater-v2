<!DOCTYPE html>
<html>

<head>
  <title>Garage Heater</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <div class="controls">
    <div class="headder">
      <h1>Garage Heater</h1>
      <span class="settings">
        <a href="/settings.html" style="text-decoration: none;">
          <button class="settings_button" id="SettingsButton">
            <div>
              <svg fill="currentColor" height="35" width="35" version="1.1" id="Capa_1"
                xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 489.802 489.802" xml:space="preserve">
                <g>
                  <path d="M20,256.5h113.3c4.6,21.4,23.6,37.5,46.4,37.5s41.8-16.1,46.4-37.5H469c11,0,20-9,20-20s-9-20-20-20H226.1
                    c-4.6-21.4-23.6-37.5-46.4-37.5s-41.8,16.1-46.4,37.5H20c-11,0-20,9-20,20S9,256.5,20,256.5z M179.7,216.5
                    c11,0,20,9,20,20s-9,20-20,20s-20-9-20-20S168.7,216.5,179.7,216.5z" />
                  <path d="M469,84.7H355.7c-4.6-21.4-23.6-37.5-46.4-37.5s-41.8,16.1-46.4,37.5H20c-11,0-20,9-20,20s9,20,20,20h243.3
                    c4.6,21.4,23.6,37.5,46.4,37.5s41.8-16.1,46.4-37.5H469c11,0,20-9,20-20S480,84.7,469,84.7z M309.3,124.7c-11,0-20-9-20-20
                    s9-20,20-20s20,9,20,20S320.3,124.7,309.3,124.7z" />
                  <path d="M469,385.2H355.7c-4.6-21.4-23.6-37.5-46.4-37.5s-41.8,16.1-46.4,37.5H20c-11,0-20,9-20,20s9,20,20,20h243.3
                    c4.6,21.4,23.6,37.5,46.4,37.5s41.8-16.1,46.4-37.5H469c11,0,20-9,20-20S480,385.2,469,385.2z M309.3,425.2c-11,0-20-9-20-20
                    s9-20,20-20s20,9,20,20S320.3,425.2,309.3,425.2z" />
                </g>
              </svg>
            </div>
          </button>
        </a>
      </span>
    </div>
    <div class="controls2">
      <span class="status">
        <span class="statusElement" id="gas">gas</span>
        <span class="statusElement" id="exhaust">exhaust</span>
        <span class="statusElement" id="fan">fan</span>
      </span>
      <p>
      <p>System State</p>
      <a><button class="button buttonNotSelected" id="UnOccupied" onclick="setMode('1')">Un-Occupied</button></a>
      <a><button class="button buttonNotSelected" id="HeatOn" onclick="setMode('2')">Heat On</button></a><br>
      <a><button class="button buttonNotSelected" id="Exhaust" onclick="setMode('4')">Exhaust</button></a>
      <a><button class="button buttonNotSelected" id="ForceFan" onclick="setMode('5')">Force Fan</button></a>
      <a><button class="button button2 buttonRedNotSelected" id="FullOff" onclick="setMode('3')">Full Off</button></a>
      </p>
      <p class="disable-dbl-tap-zoom>">
      <p>High Temp</p>
      <p class="temperature"><span id="High">N/A</span></p>
      <a><button class="tempButton down disable-dbl-tap-zoom" onclick="highTempBumpDown()">-</button></a>
      <a><button class="tempButton up disable-dbl-tap-zoom" onclick="highTempBumpUp()">+</button></a>
      </p>
      <p class="disable-dbl-tap-zoom>">
      <p>Low Temp</p>
      <p class="temperature"><span id="Low">N/A</span></p>
      <a><button class="tempButton down disable-dbl-tap-zoom" onclick="lowTempBumpDown()">-</button></a>
      <a><button class="tempButton up disable-dbl-tap-zoom" onclick="lowTempBumpUp()">+</button></a>
      </p>
      <p>Sensor Readings
      <div class="sensor_div">
        <span class="sensor_val_container">
          <div class="sensor_title">On Board</div>
          <div class="sensor_value"><span id="Room">N/A</span></div>
        </span>
        <span class="sensor_val_container">
          <div class="sensor_title">In Room</div>
          <div class="sensor_value"><span id="Bottom">N/A</span></div>
        </span>
        <span class="sensor_val_container">
          <div class="sensor_title">Lower Vent</div>
          <div class="sensor_value"><span id="Top">N/A</span></div>
        </span>
      </div>
      </p>
      <p id="fanFailureWarning"
        style="display: none; color: #ff0000; font-weight: bold; margin-top: 10px; padding: 15px; background-color: #ffe0e0; border: 2px solid #ff0000; border-radius: 5px;">
        !! FAN FAILURE DETECTED !!<br>
        <span style="font-size: 0.9rem;">Lower fan may be broken</span>
      </p>
    </div>
  </div>
</body>

</html>

<script>

  // document.getElementById("SettingsButton").onclick = function(){
  //   console.log("Settings Pressed")
  // }




  async function setMode(number) {
    console.log("/cgi-bin/setMode?mode=" + number)
    url = "http://" + location.hostname + "/cgi-bin/setMode?mode=" + number

    let response = await fetch(url);// => response.json()).then((json) => console.log(json));
    let json = await response.json();
    console.log(json)

    document.getElementById("UnOccupied").classList.remove("buttonSelected")
    document.getElementById("HeatOn").classList.remove("buttonSelected")
    document.getElementById("FullOff").classList.remove("buttonRedSelected")
    document.getElementById("Exhaust").classList.remove("buttonSelected")
    document.getElementById("ForceFan").classList.remove("buttonSelected")

    document.getElementById("UnOccupied").classList.add("buttonNotSelected")
    document.getElementById("HeatOn").classList.add("buttonNotSelected")
    document.getElementById("FullOff").classList.add("buttonRedNotSelected")
    document.getElementById("Exhaust").classList.add("buttonNotSelected")
    document.getElementById("ForceFan").classList.add("buttonNotSelected")
    console.log(json.room_state)

    if (json.room_state == "UnOccupied") {
      console.log("set UnOccupied")
      document.getElementById("UnOccupied").classList.add("buttonSelected")
      document.getElementById("UnOccupied").classList.remove("buttonNotSelected")
    } else if (json.room_state == "Heat On") {
      console.log("set Heat On")
      document.getElementById("HeatOn").classList.add("buttonSelected")
      document.getElementById("HeatOn").classList.remove("buttonNotSelected")
    } else if (json.room_state == "Full Off") {
      console.log("set Full Off")
      document.getElementById("FullOff").classList.add("buttonRedSelected")
      document.getElementById("FullOff").classList.remove("buttonRedNotSelected")
    } else if (json.room_state == "Exhaust") {
      console.log("set Exhaust")
      document.getElementById("Exhaust").classList.add("buttonSelected")
      document.getElementById("Exhaust").classList.remove("buttonNotSelected")
    } else if (json.room_state == "Force Fan") {
      console.log("set Force Fan")
      document.getElementById("ForceFan").classList.add("buttonSelected")
      document.getElementById("ForceFan").classList.remove("buttonNotSelected")
    }

    setTimeout(GetCurrentTemps, 200);
  }

  async function highTempBumpDown() {
    console.log("/cgi-bin/bumpHighTemp?direction=down")
    url = "http://" + location.hostname + "/cgi-bin/bumpHighTemp?direction=down"

    let response = await fetch(url);// => response.json()).then((json) => console.log(json));
    let json = await response.json();
    document.getElementById("High").innerHTML = json.high_temp + String.fromCharCode(176) + "F"
  }

  async function highTempBumpUp() {
    console.log("/cgi-bin/bumpHighTemp?direction=up")
    url = "http://" + location.hostname + "/cgi-bin/bumpHighTemp?direction=up"

    let response = await fetch(url);// => response.json()).then((json) => console.log(json));
    let json = await response.json();
    document.getElementById("High").innerHTML = json.high_temp + String.fromCharCode(176) + "F"
  }

  async function lowTempBumpDown() {
    console.log("/cgi-bin/bumpLowTemp?direction=down")
    url = "http://" + location.hostname + "/cgi-bin/bumpLowTemp?direction=down"

    let response = await fetch(url);// => response.json()).then((json) => console.log(json));
    let json = await response.json();
    document.getElementById("Low").innerHTML = json.low_temp + String.fromCharCode(176) + "F"
  }

  async function lowTempBumpUp() {
    console.log("/cgi-bin/bumpLowTemp?direction=up")
    url = "http://" + location.hostname + "/cgi-bin/bumpLowTemp?direction=up"

    let response = await fetch(url);// => response.json()).then((json) => console.log(json));
    let json = await response.json();
    document.getElementById("Low").innerHTML = json.low_temp + String.fromCharCode(176) + "F"
  }

  async function GetCurrentTemps() {
    url = "http://" + location.hostname + "/cgi-bin/getTemps"

    let response = await fetch(url);// => response.json()).then((json) => console.log(json));
    let json = await response.json();

    console.log(json)
    console.log("Lower Vent", json.lower_vent_temp)
    console.log("In Room", json.in_room_temp)
    console.log("On Board", json.on_board_temp)

    // Display temps with connection status
    if (json.on_board_temp_connected) {
      document.getElementById("Room").innerHTML = json.on_board_temp + String.fromCharCode(176) + "F"
      document.getElementById("Room").style.color = "white";
    } else {
      document.getElementById("Room").innerHTML = "N/A"
      document.getElementById("Room").style.color = "#f44336";
    }

    if (json.in_room_temp_connected) {
      document.getElementById("Bottom").innerHTML = json.in_room_temp + String.fromCharCode(176) + "F"
      document.getElementById("Bottom").style.color = "white";
    } else {
      document.getElementById("Bottom").innerHTML = "N/A"
      document.getElementById("Bottom").style.color = "#f44336";
    }

    if (json.lower_vent_temp_connected) {
      document.getElementById("Top").innerHTML = json.lower_vent_temp + String.fromCharCode(176) + "F"
      document.getElementById("Top").style.color = "white";
    } else {
      document.getElementById("Top").innerHTML = "N/A"
      document.getElementById("Top").style.color = "#f44336";
    }

    document.getElementById("High").innerHTML = json.high_temp + String.fromCharCode(176) + "F"
    document.getElementById("Low").innerHTML = json.low_temp + String.fromCharCode(176) + "F"

    document.getElementById("UnOccupied").classList.remove("buttonSelected")
    document.getElementById("HeatOn").classList.remove("buttonSelected")
    document.getElementById("FullOff").classList.remove("buttonRedSelected")
    document.getElementById("Exhaust").classList.remove("buttonSelected")
    document.getElementById("ForceFan").classList.remove("buttonSelected")

    document.getElementById("UnOccupied").classList.add("buttonNotSelected")
    document.getElementById("HeatOn").classList.add("buttonNotSelected")
    document.getElementById("FullOff").classList.add("buttonRedNotSelected")
    document.getElementById("Exhaust").classList.add("buttonNotSelected")
    document.getElementById("ForceFan").classList.add("buttonNotSelected")


    if (json.room_state == "UnOccupied") {
      document.getElementById("UnOccupied").classList.add("buttonSelected")
      document.getElementById("UnOccupied").classList.remove("buttonNotSelected")
    } else if (json.room_state == "Heat On") {
      document.getElementById("HeatOn").classList.add("buttonSelected")
      document.getElementById("HeatOn").classList.remove("buttonNotSelected")
    } else if (json.room_state == "Full Off") {
      document.getElementById("FullOff").classList.add("buttonRedSelected")
      document.getElementById("FullOff").classList.remove("buttonRedNotSelected")
    } else if (json.room_state == "Exhaust") {
      document.getElementById("Exhaust").classList.add("buttonSelected")
      document.getElementById("Exhaust").classList.remove("buttonNotSelected")
    } else if (json.room_state == "Force Fan") {
      document.getElementById("ForceFan").classList.add("buttonSelected")
      document.getElementById("ForceFan").classList.remove("buttonNotSelected")
    }

    if (json.gas_on) {
      document.getElementById("gas").classList.add("statusElementOn")
    } else {
      document.getElementById("gas").classList.remove("statusElementOn")
    }

    if (json.fan_on) {
      document.getElementById("fan").classList.add("statusElementOn")
    } else {
      document.getElementById("fan").classList.remove("statusElementOn")
    }

    if (json.exhaust_on) {
      document.getElementById("exhaust").classList.add("statusElementOn")
    } else {
      document.getElementById("exhaust").classList.remove("statusElementOn")
    }

    // Show/hide fan failure warning
    if (json.fan_failure) {
      document.getElementById("fanFailureWarning").style.display = "block";
    } else {
      document.getElementById("fanFailureWarning").style.display = "none";
    }
  }
  setInterval(GetCurrentTemps, 2000)
  GetCurrentTemps();

</script>